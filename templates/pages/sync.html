{% extends "layout.html" %}

{% block title %}Aktarım{% endblock %}

{% block extra_css %}
<style>
    /* Step Indicators */
    .step-indicators {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
    }
    .step-item {
        flex: 1;
        text-align: center;
        padding: 10px;
        position: relative;
    }
    .step-item:not(:last-child)::after {
        content: '';
        position: absolute;
        top: 50%;
        right: -10%;
        width: 20%;
        height: 2px;
        background: #dee2e6;
    }
    .step-item.active .step-icon { background: var(--accent-color); color: white; }
    .step-item.completed .step-icon { background: #28a745; color: white; }
    .step-item.completed::after { background: #28a745; }
    .step-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #dee2e6;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 5px;
        font-size: 16px;
    }
    .step-label { font-size: 12px; color: #6c757d; }
    
    /* Stats Mini Cards */
    .stat-mini {
        text-align: center;
        padding: 15px;
        border-radius: 8px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .stat-mini h4 { margin: 0; font-size: 1.5rem; }
    .stat-mini small { opacity: 0.8; }
    .stat-mini.success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .stat-mini.warning { background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%); }
    .stat-mini.danger { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); }
    
    /* Current Product */
    .current-product-card {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        color: white;
        border-radius: 12px;
        padding: 20px;
    }
    .current-product-card h6 { color: rgba(255,255,255,0.7); margin-bottom: 10px; }
    .current-product-card .product-title { font-size: 1.2rem; font-weight: 600; }
    .current-product-card .product-sku { color: #69b4ff; font-family: monospace; }
    
    /* Created Products */
    .product-link-item {
        padding: 12px 15px;
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.2s;
    }
    .product-link-item:hover { background: #f8f9fa; }
    .product-link-item:last-child { border-bottom: none; }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h2><i class="fas fa-play-circle"></i> Aktarım</h2>
</div>

<!-- Step Indicators -->
<div class="step-indicators" id="stepIndicators">
    <div class="step-item" id="step-fetch">
        <div class="step-icon"><i class="fas fa-download"></i></div>
        <div class="step-label">Veri Çekme</div>
    </div>
    <div class="step-item" id="step-cache">
        <div class="step-icon"><i class="fas fa-database"></i></div>
        <div class="step-label">Önbellek</div>
    </div>
    <div class="step-item" id="step-group">
        <div class="step-icon"><i class="fas fa-layer-group"></i></div>
        <div class="step-label">Gruplama</div>
    </div>
    <div class="step-item" id="step-sync">
        <div class="step-icon"><i class="fas fa-cloud-upload-alt"></i></div>
        <div class="step-label">Shopify Sync</div>
    </div>
</div>

<!-- Stats Row -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-mini">
            <h4 id="stat-total">0</h4>
            <small>Toplam</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-mini success">
            <h4 id="stat-created">0</h4>
            <small>Oluşturulan</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-mini warning">
            <h4 id="stat-updated">0</h4>
            <small>Güncellenen</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-mini danger">
            <h4 id="stat-errors">0</h4>
            <small>Hatalar</small>
        </div>
    </div>
</div>

<!-- Sync Controls -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h5 class="mb-0" id="syncStatusText">Aktarım Durumu: Bekliyor</h5>
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-success btn-lg me-2" id="startSyncBtn" onclick="startSync()">
                    <i class="fas fa-play"></i> Aktarımı Başlat
                </button>
                <button class="btn btn-danger btn-lg" id="stopSyncBtn" onclick="stopSync()" style="display: none;">
                    <i class="fas fa-stop"></i> Durdur
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Progress -->
<div class="card mb-4" id="progressCard" style="display: none;">
    <div class="card-body">
        <div class="d-flex justify-content-between mb-2">
            <span id="progressText">0 / 0</span>
            <span id="progressPercent">0%</span>
        </div>
        <div class="progress" style="height: 30px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar" 
                 role="progressbar" style="width: 0%"></div>
        </div>
    </div>
</div>

<!-- Current Product -->
<div class="current-product-card mb-4" id="currentProductCard" style="display: none;">
    <h6><i class="fas fa-spinner fa-spin"></i> Şu An İşleniyor</h6>
    <div class="product-title" id="currentProductTitle">-</div>
    <div class="product-sku" id="currentProductSku">SKU: -</div>
    <div class="mt-2 text-muted small" id="currentProductIndex">-</div>
</div>

<!-- Console Output -->
<div class="card">
    <div class="card-header d-flex justify-content-between">
        <h5 class="mb-0"><i class="fas fa-terminal"></i> Aktarım Detayları</h5>
        <button class="btn btn-sm btn-outline-secondary" onclick="clearConsole()">
            <i class="fas fa-trash"></i> Temizle
        </button>
    </div>
    <div class="card-body p-0">
        <div class="console-output" id="consoleOutput" style="max-height: 300px;">
            <div class="console-line">
                <span class="console-prompt">$</span>
                <span class="console-text">Aktarım başlatıldığında loglar burada görünecek...</span>
            </div>
        </div>
    </div>
</div>

<!-- Created Products -->
<div class="card mt-4" id="createdProductsCard" style="display: none;">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="fas fa-check-circle"></i> Oluşturulan Ürünler</h5>
    </div>
    <div class="card-body p-0" id="createdProductsList">
        <!-- Products will be listed here -->
    </div>
</div>

<!-- Error Log -->
<div class="card mt-4" id="errorLogCard" style="display: none;">
    <div class="card-header bg-danger text-white">
        <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Hatalar</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-sm mb-0" id="errorLogTable">
                <thead>
                    <tr><th>SKU</th><th>Hata</th><th>Zaman</th></tr>
                </thead>
                <tbody id="errorLogBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-tools"></i> Hızlı İşlemler</h5>
    </div>
    <div class="card-body">
        <div class="d-flex gap-2 flex-wrap">
            <button class="btn btn-outline-warning" onclick="rollbackLastSync()">
                <i class="fas fa-undo"></i> Son Aktarımı Geri Al
            </button>
            <button class="btn btn-outline-danger" onclick="deleteAllProducts()">
                <i class="fas fa-trash-alt"></i> Tüm Ürünleri Sil
            </button>
            <a href="{{ url_for('page_sync_options') }}" class="btn btn-outline-primary">
                <i class="fas fa-filter"></i> Filtreleri Düzenle
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let syncInterval = null;
let autoStart = new URLSearchParams(window.location.search).get('autostart');
let lastLogCount = 0;

document.addEventListener('DOMContentLoaded', async function() {
    // First check if sync is already running
    await checkAndResumeSync();
    
    // Then start new sync if autostart
    if (autoStart === '1') {
        startSync();
    }
});

async function checkAndResumeSync() {
    try {
        const response = await fetch('/api/sync/status');
        const data = await response.json();
        
        if (data.is_running) {
            // Sync is running - resume UI
            console.log('Resuming active sync...');
            document.getElementById('startSyncBtn').style.display = 'none';
            document.getElementById('stopSyncBtn').style.display = 'inline-block';
            document.getElementById('progressCard').style.display = 'block';
            document.getElementById('currentProductCard').style.display = 'block';
            document.getElementById('syncStatusText').textContent = 'Aktarım Durumu: Devam ediyor...';
            
            // Update UI with current state
            updateProgress(data);
            updateStats(data.stats);
            updateStepIndicators(data.step || data.message || '');
            if (data.logs) {
                lastLogCount = 0;
                updateLogs(data.logs);
            }
            
            // Start polling
            if (!syncInterval) {
                startPolling();
            }
        } else if (data.last_sync) {
            // Show last sync stats
            updateStats(data.last_sync);
        }
    } catch (error) {
        console.error('Resume check error:', error);
    }
}

async function startSync() {
    document.getElementById('startSyncBtn').style.display = 'none';
    document.getElementById('stopSyncBtn').style.display = 'inline-block';
    document.getElementById('progressCard').style.display = 'block';
    document.getElementById('currentProductCard').style.display = 'block';
    document.getElementById('syncStatusText').textContent = 'Aktarım Durumu: Çalışıyor...';
    
    // Reset
    resetStepIndicators();
    resetStats();
    clearConsole();
    document.getElementById('createdProductsCard').style.display = 'none';
    document.getElementById('errorLogCard').style.display = 'none';
    lastLogCount = 0;
    
    addLog('Aktarım başlatılıyor...', 'info');
    
    try {
        const response = await fetch('/api/sync/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });
        const data = await response.json();
        
        if (data.status === 'success') {
            addLog('Aktarım başladı: ' + (data.sync_id || 'OK'), 'success');
            startPolling();
        } else {
            addLog('Hata: ' + data.message, 'error');
            resetUI();
        }
    } catch (error) {
        addLog('Bağlantı hatası: ' + error.message, 'error');
        resetUI();
    }
}

async function stopSync() {
    try {
        await fetch('/api/sync/stop', { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });
        addLog('Aktarım durduruldu', 'warning');
        resetUI();
    } catch (error) {
        addLog('Durdurma hatası: ' + error.message, 'error');
    }
}

function startPolling() {
    syncInterval = setInterval(checkSyncStatus, 2000);
}

async function checkSyncStatus() {
    try {
        const response = await fetch('/api/sync/status');
        const data = await response.json();
        
        if (data.status === 'success' || data.is_running !== undefined) {
            updateProgress(data);
            updateStepIndicators(data.step || data.message || '');
            updateStats(data.stats);
            updateCurrentProduct(data.current_product);
            updateLogs(data.logs);
            updateErrors(data.errors);
            
            if (!data.is_running && syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
                
                // Show completion
                completeAllSteps();
                
                if (data.last_sync) {
                    addLog(`✅ Aktarım tamamlandı: ${data.last_sync.created || 0} oluşturuldu, ${data.last_sync.errors || 0} hata`, 
                           data.last_sync.errors > 0 ? 'warning' : 'success');
                }
                
                // Show created products
                if (data.created_products && data.created_products.length > 0) {
                    displayCreatedProducts(data.created_products);
                }
                
                resetUI();
            }
        }
    } catch (error) {
        console.error('Status check error:', error);
    }
}

function updateProgress(data) {
    const progress = data.progress || 0;
    const current = data.current_index || 0;
    const total = data.total || 0;
    
    document.getElementById('progressBar').style.width = progress + '%';
    document.getElementById('progressPercent').textContent = Math.round(progress) + '%';
    document.getElementById('progressText').textContent = `${current} / ${total}`;
}

function updateStats(stats) {
    if (!stats) return;
    document.getElementById('stat-total').textContent = stats.total || 0;
    document.getElementById('stat-created').textContent = stats.created || 0;
    document.getElementById('stat-updated').textContent = stats.updated || 0;
    document.getElementById('stat-errors').textContent = stats.errors || 0;
}

function resetStats() {
    document.getElementById('stat-total').textContent = '0';
    document.getElementById('stat-created').textContent = '0';
    document.getElementById('stat-updated').textContent = '0';
    document.getElementById('stat-errors').textContent = '0';
}

function updateCurrentProduct(product) {
    if (!product) return;
    document.getElementById('currentProductTitle').textContent = product.title || product.styleName || '-';
    document.getElementById('currentProductSku').textContent = 'SKU: ' + (product.sku || '-');
    if (product.index !== undefined && product.total) {
        document.getElementById('currentProductIndex').textContent = `${product.index + 1} / ${product.total}`;
    }
}

function updateStepIndicators(stepOrMessage) {
    const steps = ['step-fetch', 'step-cache', 'step-group', 'step-sync'];
    const msg = (stepOrMessage || '').toLowerCase();
    
    let activeIndex = -1;
    if (msg.includes('fetch') || msg.includes('çekil')) activeIndex = 0;
    else if (msg.includes('cache') || msg.includes('önbellek') || msg.includes('veritabanı')) activeIndex = 1;
    else if (msg.includes('group') || msg.includes('grupla') || msg.includes('style')) activeIndex = 2;
    else if (msg.includes('sync') || msg.includes('shopify') || msg.includes('aktarıl') || msg.includes('creat')) activeIndex = 3;
    
    steps.forEach((stepId, idx) => {
        const el = document.getElementById(stepId);
        el.classList.remove('active', 'completed');
        if (idx < activeIndex) el.classList.add('completed');
        else if (idx === activeIndex) el.classList.add('active');
    });
}

function completeAllSteps() {
    ['step-fetch', 'step-cache', 'step-group', 'step-sync'].forEach(id => {
        document.getElementById(id).classList.remove('active');
        document.getElementById(id).classList.add('completed');
    });
}

function resetStepIndicators() {
    ['step-fetch', 'step-cache', 'step-group', 'step-sync'].forEach(id => {
        document.getElementById(id).classList.remove('active', 'completed');
    });
}

function updateLogs(logs) {
    if (!logs || logs.length === 0) return;
    
    if (logs.length > lastLogCount) {
        const newLogs = logs.slice(lastLogCount);
        newLogs.forEach(log => {
            const msg = typeof log === 'string' ? log : log.message;
            const level = typeof log === 'object' ? log.level : 'info';
            addLog(msg, level);
        });
        lastLogCount = logs.length;
    }
}

function updateErrors(errors) {
    if (!errors || errors.length === 0) return;
    
    document.getElementById('errorLogCard').style.display = 'block';
    const tbody = document.getElementById('errorLogBody');
    tbody.innerHTML = errors.map(err => `
        <tr>
            <td><code>${err.sku || '-'}</code></td>
            <td>${err.error || err.message || '-'}</td>
            <td>${err.timestamp ? new Date(err.timestamp).toLocaleTimeString() : '-'}</td>
        </tr>
    `).join('');
}

function displayCreatedProducts(products) {
    const card = document.getElementById('createdProductsCard');
    const list = document.getElementById('createdProductsList');
    
    card.style.display = 'block';
    list.innerHTML = products.slice(0, 50).map((p, i) => `
        <div class="product-link-item">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>${i + 1}. ${p.title || 'Ürün'}</strong><br>
                    <small class="text-muted">ID: ${p.shopify_id || p.id} | Variants: ${p.variants_count || 0}</small>
                </div>
                <div>
                    ${p.product_url ? `<a href="${p.product_url}" target="_blank" class="btn btn-sm btn-primary me-1"><i class="fas fa-external-link-alt"></i></a>` : ''}
                    ${p.shopify_url ? `<a href="${p.shopify_url}" target="_blank" class="btn btn-sm btn-secondary"><i class="fas fa-cog"></i></a>` : ''}
                </div>
            </div>
        </div>
    `).join('');
    
    if (products.length > 50) {
        list.innerHTML += `<div class="p-3 text-center text-muted">+${products.length - 50} daha...</div>`;
    }
}

function addLog(message, type = 'info') {
    const consoleOutput = document.getElementById('consoleOutput');
    const timestamp = new Date().toLocaleTimeString();
    
    const logLine = document.createElement('div');
    logLine.className = `console-line log-${type}`;
    logLine.innerHTML = `
        <span class="console-prompt">$</span>
        <span class="console-text">[${timestamp}] ${message}</span>
    `;
    
    consoleOutput.insertBefore(logLine, consoleOutput.firstChild);
    consoleOutput.scrollTop = 0;
}

function clearConsole() {
    document.getElementById('consoleOutput').innerHTML = '';
    lastLogCount = 0;
}

function resetUI() {
    document.getElementById('startSyncBtn').style.display = 'inline-block';
    document.getElementById('stopSyncBtn').style.display = 'none';
    document.getElementById('currentProductCard').style.display = 'none';
    document.getElementById('syncStatusText').textContent = 'Aktarım Durumu: Bekliyor';
}

async function rollbackLastSync() {
    if (!confirm('Son aktarımda oluşturulan ürünler silinecek. Devam etmek istiyor musunuz?')) return;
    
    addLog('Geri alma başlatılıyor...', 'warning');
    
    try {
        const response = await fetch('/api/sync/rollback-last', { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });
        const data = await response.json();
        
        if (data.status === 'success') {
            addLog('✅ Geri alma başarılı: ' + (data.message || data.deleted + ' ürün silindi'), 'success');
            alert('Geri alma başarılı!');
        } else {
            addLog('❌ Hata: ' + data.message, 'error');
            alert('Hata: ' + data.message);
        }
    } catch (error) {
        addLog('❌ Hata: ' + error.message, 'error');
        alert('Hata: ' + error.message);
    }
}

async function deleteAllProducts() {
    if (!confirm('TÜM Shopify ürünleri silinecek! Bu işlem geri alınamaz.')) return;
    if (!confirm('Emin misiniz? Bu işlem TÜM ürünleri silecek!')) return;
    
    addLog('Tüm ürünler siliniyor...', 'warning');
    
    try {
        const response = await fetch('/api/shopify/delete-all', { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });
        const data = await response.json();
        
        if (data.status === 'success') {
            addLog('✅ ' + (data.message || 'Silme başarılı'), 'success');
            alert('Silme başarılı!');
        } else {
            addLog('❌ Hata: ' + data.message, 'error');
            alert('Hata: ' + data.message);
        }
    } catch (error) {
        addLog('❌ Hata: ' + error.message, 'error');
        alert('Hata: ' + error.message);
    }
}
</script>
{% endblock %}
