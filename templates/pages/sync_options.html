{% extends "layout.html" %}

{% block title %}Aktarƒ±m Se√ßenekleri{% endblock %}

{% block extra_css %}
<style>
    .nav-pills .nav-link {
        border-radius: 25px;
        padding: 10px 20px;
        margin-right: 10px;
        background: #e9ecef;
        color: #495057;
    }
    .nav-pills .nav-link.active {
        background: var(--accent-color);
        color: white;
    }
    .nav-pills .nav-link:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .filter-checkbox {
        padding: 8px 12px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .filter-checkbox:hover {
        background: #f8f9fa;
    }
    .filter-checkbox.selected {
        background: #e3f2fd;
        border-color: #2196f3;
    }
    .location-item {
        padding: 15px;
        border: 2px solid #dee2e6;
        border-radius: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .location-item:hover {
        border-color: #90caf9;
    }
    .location-item.selected {
        border-color: var(--accent-color);
        background: #fff5f5;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <h2><i class="fas fa-sliders-h"></i> Aktarƒ±m Se√ßenekleri</h2>
    <button type="button" class="btn btn-warning btn-sm" onclick="resetAllFilters()">
        <i class="fas fa-redo"></i> Filtreleri Sƒ±fƒ±rla
    </button>
</div>

<div class="card">
    <div class="card-body">
        <!-- Step Indicator -->
        <ul class="nav nav-pills mb-4" id="filterSteps" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="step1-tab" data-bs-toggle="pill" data-bs-target="#step1" type="button">
                    <i class="fas fa-list"></i> 1. Kategoriler
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="step2-tab" data-bs-toggle="pill" data-bs-target="#step2" type="button" disabled>
                    <i class="fas fa-tshirt"></i> 2. Stiller
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="step3-tab" data-bs-toggle="pill" data-bs-target="#step3" type="button" disabled>
                    <i class="fas fa-tag"></i> 3. Markalar
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="step4-tab" data-bs-toggle="pill" data-bs-target="#step4" type="button" disabled>
                    <i class="fas fa-eye"></i> 4. √ñnizleme + Lokasyon
                </button>
            </li>
        </ul>

        <!-- Step Content -->
        <div class="tab-content">
            <!-- Step 1: Categories -->
            <div class="tab-pane fade show active" id="step1" role="tabpanel">
                <button type="button" class="btn btn-primary mb-3" onclick="loadCategories()">
                    <i class="fas fa-sync"></i> Kategorileri Y√ºkle
                </button>
                <input type="text" id="categorySearch" class="form-control mb-3" placeholder="üîç Kategori ara..." oninput="filterList('categoriesList', this.value)">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="selectAllCategories" onchange="toggleAll('categories')">
                    <label class="form-check-label fw-bold">T√ºm√ºn√º Se√ß</label>
                </div>
                <div id="categoriesList" class="border rounded p-3" style="max-height: 400px; overflow-y: auto;">
                    <p class="text-muted text-center">Kategorileri y√ºklemek i√ßin butona tƒ±klayƒ±n</p>
                </div>
                <div class="mt-3">
                    <button type="button" class="btn btn-success" onclick="goToStep(2)" id="step1NextBtn" disabled>
                        ƒ∞leri: Stilleri Se√ß <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Step 2: Styles -->
            <div class="tab-pane fade" id="step2" role="tabpanel">
                <p class="text-muted mb-3"><i class="fas fa-info-circle"></i> Stiller se√ßilen kategorilere g√∂re y√ºkleniyor...</p>
                <input type="text" id="styleSearch" class="form-control mb-3" placeholder="üîç Stil ara..." oninput="filterList('stylesList', this.value)">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="selectAllStyles" onchange="toggleAll('styles')">
                    <label class="form-check-label fw-bold">T√ºm√ºn√º Se√ß</label>
                </div>
                <div id="stylesList" class="border rounded p-3" style="max-height: 400px; overflow-y: auto;">
                    <p class="text-muted text-center">√ñnce kategorileri se√ßin</p>
                </div>
                <div class="mt-3">
                    <button type="button" class="btn btn-secondary" onclick="goToStep(1)">
                        <i class="fas fa-arrow-left"></i> Geri
                    </button>
                    <button type="button" class="btn btn-success" onclick="goToStep(3)" id="step2NextBtn" disabled>
                        ƒ∞leri: Markalarƒ± Se√ß <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Step 3: Brands -->
            <div class="tab-pane fade" id="step3" role="tabpanel">
                <button type="button" class="btn btn-primary mb-3" onclick="loadBrands()">
                    <i class="fas fa-sync"></i> Markalarƒ± Y√ºkle
                </button>
                <input type="text" id="brandSearch" class="form-control mb-3" placeholder="üîç Marka ara..." oninput="filterList('brandsList', this.value)">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="selectAllBrands" onchange="toggleAll('brands')">
                    <label class="form-check-label fw-bold">T√ºm√ºn√º Se√ß</label>
                </div>
                <div id="brandsList" class="border rounded p-3" style="max-height: 400px; overflow-y: auto;">
                    <p class="text-muted text-center">√ñnce stilleri se√ßin</p>
                </div>
                <div class="mt-3">
                    <button type="button" class="btn btn-secondary" onclick="goToStep(2)">
                        <i class="fas fa-arrow-left"></i> Geri
                    </button>
                    <button type="button" class="btn btn-success" onclick="goToStep(4)" id="step3NextBtn" disabled>
                        ƒ∞leri: √ñnizleme <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Step 4: Preview + Location -->
            <div class="tab-pane fade" id="step4" role="tabpanel">
                <h5 class="mb-3">üìã √ñnizleme ve Lokasyon Se√ßimi</h5>
                <button type="button" class="btn btn-primary mb-3" onclick="loadPreview()">
                    <i class="fas fa-sync"></i> √ñnizleme Y√ºkle
                </button>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>√ñNEMLƒ∞:</strong> Lokasyon se√ßimi zorunludur. En y√ºksek stoƒüu olan lokasyon otomatik se√ßilecek.
                </div>
                
                <div id="previewContainer" class="border rounded p-3" style="max-height: 500px; overflow-y: auto;">
                    <p class="text-muted text-center">√ñnizleme y√ºklemek i√ßin butona tƒ±klayƒ±n</p>
                </div>
                
                <div class="mt-3">
                    <button type="button" class="btn btn-secondary" onclick="goToStep(3)">
                        <i class="fas fa-arrow-left"></i> Geri
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Save and Start Button -->
<div class="card mt-4">
    <div class="card-body text-center">
        <button type="button" class="btn btn-accent btn-lg" onclick="saveAndStartSync()" id="saveStartBtn" disabled>
            <i class="fas fa-rocket"></i> Kaydet ve Aktarƒ±mƒ± Ba≈ülat
        </button>
        <p class="text-muted mt-2 mb-0">Se√ßilen filtreleri kaydet ve aktarƒ±m sayfasƒ±na git</p>
    </div>
</div>

<!-- Selected Summary -->
<div class="card mt-4" id="filtersSummary" style="display: none;">
    <div class="card-header bg-info text-white">
        <h6 class="mb-0"><i class="fas fa-list-check"></i> Se√ßilen Filtreler</h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3"><strong>Kategoriler:</strong> <span id="summaryCategories">0</span></div>
            <div class="col-md-3"><strong>Stiller:</strong> <span id="summaryStyles">0</span></div>
            <div class="col-md-3"><strong>Markalar:</strong> <span id="summaryBrands">0</span></div>
            <div class="col-md-3"><strong>Lokasyon:</strong> <span id="summaryLocation">-</span></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// State
let selectedCategories = [];
let selectedStyles = [];
let selectedBrands = [];
let selectedLocation = null;
let allCategories = [];
let allStyles = [];
let allBrands = [];

// Navigation
function goToStep(step) {
    // Enable target tab
    document.getElementById(`step${step}-tab`).disabled = false;
    
    // Activate tab using Bootstrap
    const tab = new bootstrap.Tab(document.getElementById(`step${step}-tab`));
    tab.show();
    
    // Auto-load data based on step
    if (step === 2 && selectedCategories.length > 0) {
        loadStyles();
    } else if (step === 3 && selectedStyles.length > 0) {
        loadBrands();
    }
}

// Load Categories
async function loadCategories() {
    const container = document.getElementById('categoriesList');
    container.innerHTML = '<div class="text-center"><div class="spinner-border"></div> Y√ºkleniyor...</div>';
    
    try {
        const response = await fetch('/api/categories', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        
        if (data.status === 'success' && data.categories) {
            allCategories = data.categories;
            renderCategories(data.categories);
        } else {
            container.innerHTML = `<div class="alert alert-danger">${data.message || 'Y√ºkleme hatasƒ±'}</div>`;
        }
    } catch (error) {
        container.innerHTML = `<div class="alert alert-danger">Hata: ${error.message}</div>`;
    }
}

function renderCategories(categories) {
    const container = document.getElementById('categoriesList');
    container.innerHTML = categories.map(cat => `
        <div class="filter-checkbox ${selectedCategories.includes(cat.categoryID) ? 'selected' : ''}" 
             data-id="${cat.categoryID}" data-name="${cat.categoryName}" onclick="toggleItem('categories', ${cat.categoryID}, this)">
            <input type="checkbox" ${selectedCategories.includes(cat.categoryID) ? 'checked' : ''} style="pointer-events: none;">
            ${cat.categoryName}
        </div>
    `).join('');
    updateButtons();
}

// Load Styles
async function loadStyles() {
    const container = document.getElementById('stylesList');
    container.innerHTML = '<div class="text-center"><div class="spinner-border"></div> Y√ºkleniyor...</div>';
    
    try {
        const response = await fetch('/api/styles', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ categories: selectedCategories })
        });
        const data = await response.json();
        
        if (data.status === 'success' && data.styles) {
            allStyles = data.styles;
            renderStyles(data.styles);
        } else {
            container.innerHTML = `<div class="alert alert-danger">${data.message || 'Y√ºkleme hatasƒ±'}</div>`;
        }
    } catch (error) {
        container.innerHTML = `<div class="alert alert-danger">Hata: ${error.message}</div>`;
    }
}

function renderStyles(styles) {
    const container = document.getElementById('stylesList');
    container.innerHTML = styles.slice(0, 200).map(style => `
        <div class="filter-checkbox ${selectedStyles.includes(style.styleID) ? 'selected' : ''}" 
             data-id="${style.styleID}" data-name="${style.styleName}" onclick="toggleItem('styles', ${style.styleID}, this)">
            <input type="checkbox" ${selectedStyles.includes(style.styleID) ? 'checked' : ''} style="pointer-events: none;">
            <strong>${style.styleName}</strong>
            <small class="text-muted ms-2">${style.brandName || ''}</small>
        </div>
    `).join('');
    
    if (styles.length > 200) {
        container.innerHTML += `<p class="text-muted text-center mt-2">${styles.length - 200} daha var. Arama yapƒ±n.</p>`;
    }
    updateButtons();
}

// Load Brands
async function loadBrands() {
    const container = document.getElementById('brandsList');
    container.innerHTML = '<div class="text-center"><div class="spinner-border"></div> Y√ºkleniyor...</div>';
    
    try {
        const response = await fetch('/api/brands', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ styles: selectedStyles })
        });
        const data = await response.json();
        
        if (data.status === 'success' && data.brands) {
            allBrands = data.brands;
            renderBrands(data.brands);
        } else {
            container.innerHTML = `<div class="alert alert-danger">${data.message || 'Y√ºkleme hatasƒ±'}</div>`;
        }
    } catch (error) {
        container.innerHTML = `<div class="alert alert-danger">Hata: ${error.message}</div>`;
    }
}

function renderBrands(brands) {
    const container = document.getElementById('brandsList');
    container.innerHTML = brands.map(brand => `
        <div class="filter-checkbox ${selectedBrands.includes(brand.brandID) ? 'selected' : ''}" 
             data-id="${brand.brandID}" data-name="${brand.brandName}" onclick="toggleItem('brands', ${brand.brandID}, this)">
            <input type="checkbox" ${selectedBrands.includes(brand.brandID) ? 'checked' : ''} style="pointer-events: none;">
            ${brand.brandName}
        </div>
    `).join('');
    updateButtons();
}

// Load Preview with Locations
async function loadPreview() {
    const container = document.getElementById('previewContainer');
    container.innerHTML = '<div class="text-center"><div class="spinner-border"></div> Y√ºkleniyor...</div>';
    
    try {
        // Get product count
        const countResponse = await fetch('/api/products/count', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                sync_options: {
                    filter_categories: selectedCategories,
                    filter_styles: selectedStyles,
                    filter_brands: selectedBrands
                }
            })
        });
        const countData = await countResponse.json();
        
        // Get warehouses
        const whResponse = await fetch('/api/warehouses', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const whData = await whResponse.json();
        
        let html = `<div class="alert alert-success"><strong>${countData.count || 0}</strong> √ºr√ºn bulundu</div>`;
        
        if (whData.status === 'success' && whData.warehouses) {
            const warehouses = whData.warehouses.sort((a, b) => (b.totalStock || 0) - (a.totalStock || 0));
            
            html += '<h6 class="mt-3">üìç Lokasyon Se√ßin (Zorunlu):</h6>';
            html += warehouses.map((wh, idx) => `
                <div class="location-item ${idx === 0 ? 'selected' : ''}" onclick="selectLocation('${wh.id}', this)">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <input type="radio" name="location" value="${wh.id}" ${idx === 0 ? 'checked' : ''}>
                            <strong class="ms-2">${wh.name}</strong>
                            ${idx === 0 ? '<span class="badge bg-success ms-2">En Y√ºksek Stok</span>' : ''}
                        </div>
                        <span class="badge bg-light text-dark">${(wh.totalStock || 0).toLocaleString()} adet</span>
                    </div>
                </div>
            `).join('');
            
            // Auto-select highest stock
            if (warehouses.length > 0) {
                selectedLocation = warehouses[0].id;
                updateButtons();
            }
        }
        
        container.innerHTML = html;
        document.getElementById('filtersSummary').style.display = 'block';
        updateSummary();
        
    } catch (error) {
        container.innerHTML = `<div class="alert alert-danger">Hata: ${error.message}</div>`;
    }
}

// Toggle item selection
function toggleItem(type, id, element) {
    let array;
    if (type === 'categories') array = selectedCategories;
    else if (type === 'styles') array = selectedStyles;
    else if (type === 'brands') array = selectedBrands;
    
    const index = array.indexOf(id);
    if (index > -1) {
        array.splice(index, 1);
        element.classList.remove('selected');
        element.querySelector('input').checked = false;
    } else {
        array.push(id);
        element.classList.add('selected');
        element.querySelector('input').checked = true;
    }
    updateButtons();
    updateSummary();
}

// Toggle all
function toggleAll(type) {
    const checkAll = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`).checked;
    const container = document.getElementById(`${type}List`);
    const items = container.querySelectorAll('.filter-checkbox');
    
    let array;
    if (type === 'categories') { array = selectedCategories; selectedCategories = []; }
    else if (type === 'styles') { array = selectedStyles; selectedStyles = []; }
    else if (type === 'brands') { array = selectedBrands; selectedBrands = []; }
    
    items.forEach(item => {
        const id = parseInt(item.dataset.id);
        if (checkAll) {
            if (type === 'categories') selectedCategories.push(id);
            else if (type === 'styles') selectedStyles.push(id);
            else if (type === 'brands') selectedBrands.push(id);
            item.classList.add('selected');
            item.querySelector('input').checked = true;
        } else {
            item.classList.remove('selected');
            item.querySelector('input').checked = false;
        }
    });
    updateButtons();
    updateSummary();
}

// Select location
function selectLocation(id, element) {
    document.querySelectorAll('.location-item').forEach(el => el.classList.remove('selected'));
    element.classList.add('selected');
    element.querySelector('input').checked = true;
    selectedLocation = id;
    updateButtons();
    updateSummary();
}

// Filter list
function filterList(containerId, query) {
    const container = document.getElementById(containerId);
    const items = container.querySelectorAll('.filter-checkbox');
    const q = query.toLowerCase();
    
    items.forEach(item => {
        const name = item.dataset.name?.toLowerCase() || '';
        item.style.display = name.includes(q) ? 'block' : 'none';
    });
}

// Update navigation buttons
function updateButtons() {
    document.getElementById('step1NextBtn').disabled = selectedCategories.length === 0;
    document.getElementById('step2NextBtn').disabled = selectedStyles.length === 0;
    document.getElementById('step3NextBtn').disabled = selectedBrands.length === 0;
    document.getElementById('saveStartBtn').disabled = !selectedLocation;
}

// Update summary
function updateSummary() {
    document.getElementById('summaryCategories').textContent = selectedCategories.length;
    document.getElementById('summaryStyles').textContent = selectedStyles.length;
    document.getElementById('summaryBrands').textContent = selectedBrands.length;
    document.getElementById('summaryLocation').textContent = selectedLocation || '-';
}

// Reset all filters
function resetAllFilters() {
    selectedCategories = [];
    selectedStyles = [];
    selectedBrands = [];
    selectedLocation = null;
    
    ['step2-tab', 'step3-tab', 'step4-tab'].forEach(id => {
        document.getElementById(id).disabled = true;
    });
    
    goToStep(1);
    document.getElementById('categoriesList').innerHTML = '<p class="text-muted text-center">Kategorileri y√ºklemek i√ßin butona tƒ±klayƒ±n</p>';
    document.getElementById('stylesList').innerHTML = '<p class="text-muted text-center">√ñnce kategorileri se√ßin</p>';
    document.getElementById('brandsList').innerHTML = '<p class="text-muted text-center">√ñnce stilleri se√ßin</p>';
    document.getElementById('previewContainer').innerHTML = '<p class="text-muted text-center">√ñnizleme y√ºklemek i√ßin butona tƒ±klayƒ±n</p>';
    document.getElementById('filtersSummary').style.display = 'none';
    updateButtons();
}

// Save and start sync
async function saveAndStartSync() {
    if (!selectedLocation) {
        alert('L√ºtfen bir lokasyon se√ßin!');
        return;
    }
    
    const syncOptions = {
        filter_categories: selectedCategories,
        filter_styles: selectedStyles,
        filter_brands: selectedBrands,
        filter_warehouses: [selectedLocation]
    };
    
    try {
        await fetch('/api/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sync_options: syncOptions })
        });
        
        // Redirect to sync page with autostart
        window.location.href = '/sync?autostart=1';
    } catch (error) {
        alert('Kaydetme hatasƒ±: ' + error.message);
    }
}

// Load saved filters on page load
document.addEventListener('DOMContentLoaded', async function() {
    try {
        const response = await fetch('/api/config');
        const data = await response.json();
        
        if (data.sync_options) {
            selectedCategories = data.sync_options.filter_categories || [];
            selectedStyles = data.sync_options.filter_styles || [];
            selectedBrands = data.sync_options.filter_brands || [];
            selectedLocation = data.sync_options.filter_warehouses?.[0] || null;
            
            if (selectedCategories.length > 0 || selectedStyles.length > 0 || selectedBrands.length > 0) {
                document.getElementById('filtersSummary').style.display = 'block';
                updateSummary();
                updateButtons();
            }
        }
    } catch (error) {
        console.error('Error loading saved filters:', error);
    }
});
</script>
{% endblock %}
