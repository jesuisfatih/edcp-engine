{% extends "layout.html" %}

{% block title %}Aktarƒ±m Se√ßenekleri{% endblock %}

{% block extra_css %}
<style>
    .nav-pills .nav-link {
        border-radius: 25px;
        padding: 10px 20px;
        margin-right: 10px;
        background: #e9ecef;
        color: #495057;
    }
    .nav-pills .nav-link.active {
        background: var(--accent-color);
        color: white;
    }
    .nav-pills .nav-link:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .filter-checkbox {
        padding: 8px 12px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .filter-checkbox:hover {
        background: #f8f9fa;
    }
    .filter-checkbox.selected {
        background: #e3f2fd;
        border-color: #2196f3;
    }
    .location-item {
        padding: 15px;
        border: 2px solid #dee2e6;
        border-radius: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .location-item:hover {
        border-color: #90caf9;
    }
    .location-item.selected {
        border-color: var(--accent-color);
        background: #fff5f5;
    }
    /* Stock Detail Modal */
    .stock-table-container {
        max-height: 500px;
        overflow-y: auto;
    }
    .stock-table th {
        position: sticky;
        top: 0;
        background: #343a40;
        color: white;
        z-index: 10;
    }
    .stock-high { color: #28a745; font-weight: bold; }
    .stock-medium { color: #ffc107; font-weight: bold; }
    .stock-low { color: #dc3545; font-weight: bold; }
    .style-header {
        background: #e3f2fd !important;
        font-weight: bold;
    }
    /* Arbitraj Indicator */
    .arbitraj-indicator {
        background: #fff3cd;
        border-radius: 5px;
        padding: 5px 10px;
        font-size: 12px;
    }
    .arbitraj-btn-active {
        background: #28a745 !important;
        border-color: #28a745 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <h2><i class="fas fa-sliders-h"></i> Aktarƒ±m Se√ßenekleri</h2>
    <button type="button" class="btn btn-warning btn-sm" onclick="resetAllFilters()">
        <i class="fas fa-redo"></i> Filtreleri Sƒ±fƒ±rla
    </button>
</div>

<div class="card">
    <div class="card-body">
        <!-- Step Indicator -->
        <ul class="nav nav-pills mb-4" id="filterSteps" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="step1-tab" data-bs-toggle="pill" data-bs-target="#step1" type="button">
                    <i class="fas fa-list"></i> 1. Kategoriler
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="step2-tab" data-bs-toggle="pill" data-bs-target="#step2" type="button" disabled>
                    <i class="fas fa-tshirt"></i> 2. Stiller
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="step3-tab" data-bs-toggle="pill" data-bs-target="#step3" type="button" disabled>
                    <i class="fas fa-tag"></i> 3. Markalar
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="step4-tab" data-bs-toggle="pill" data-bs-target="#step4" type="button" disabled>
                    <i class="fas fa-eye"></i> 4. √ñnizleme + Lokasyon
                </button>
            </li>
        </ul>

        <!-- Step Content -->
        <div class="tab-content">
            <!-- Step 1: Categories -->
            <div class="tab-pane fade show active" id="step1" role="tabpanel">
                <button type="button" class="btn btn-primary mb-3" onclick="loadCategories()">
                    <i class="fas fa-sync"></i> Kategorileri Y√ºkle
                </button>
                <input type="text" id="categorySearch" class="form-control mb-3" placeholder="üîç Kategori ara..." oninput="filterList('categoriesList', this.value)">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="selectAllCategories" onchange="toggleAll('categories')">
                    <label class="form-check-label fw-bold">T√ºm√ºn√º Se√ß</label>
                </div>
                <div id="categoriesList" class="border rounded p-3" style="max-height: 400px; overflow-y: auto;">
                    <p class="text-muted text-center">Kategorileri y√ºklemek i√ßin butona tƒ±klayƒ±n</p>
                </div>
                <div class="mt-3">
                    <button type="button" class="btn btn-success" onclick="goToStep(2)" id="step1NextBtn" disabled>
                        ƒ∞leri: Stilleri Se√ß <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Step 2: Styles -->
            <div class="tab-pane fade" id="step2" role="tabpanel">
                <p class="text-muted mb-3"><i class="fas fa-info-circle"></i> Stiller se√ßilen kategorilere g√∂re y√ºkleniyor...</p>
                <input type="text" id="styleSearch" class="form-control mb-3" placeholder="üîç Stil ara..." oninput="filterList('stylesList', this.value)">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="selectAllStyles" onchange="toggleAll('styles')">
                    <label class="form-check-label fw-bold">T√ºm√ºn√º Se√ß</label>
                </div>
                <div id="stylesList" class="border rounded p-3" style="max-height: 400px; overflow-y: auto;">
                    <p class="text-muted text-center">√ñnce kategorileri se√ßin</p>
                </div>
                <div class="mt-3">
                    <button type="button" class="btn btn-secondary" onclick="goToStep(1)">
                        <i class="fas fa-arrow-left"></i> Geri
                    </button>
                    <button type="button" class="btn btn-success" onclick="goToStep(3)" id="step2NextBtn" disabled>
                        ƒ∞leri: Markalarƒ± Se√ß <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Step 3: Brands -->
            <div class="tab-pane fade" id="step3" role="tabpanel">
                <button type="button" class="btn btn-primary mb-3" onclick="loadBrands()">
                    <i class="fas fa-sync"></i> Markalarƒ± Y√ºkle
                </button>
                <input type="text" id="brandSearch" class="form-control mb-3" placeholder="üîç Marka ara..." oninput="filterList('brandsList', this.value)">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="selectAllBrands" onchange="toggleAll('brands')">
                    <label class="form-check-label fw-bold">T√ºm√ºn√º Se√ß</label>
                </div>
                <div id="brandsList" class="border rounded p-3" style="max-height: 400px; overflow-y: auto;">
                    <p class="text-muted text-center">√ñnce stilleri se√ßin</p>
                </div>
                <div class="mt-3">
                    <button type="button" class="btn btn-secondary" onclick="goToStep(2)">
                        <i class="fas fa-arrow-left"></i> Geri
                    </button>
                    <button type="button" class="btn btn-success" onclick="goToStep(4)" id="step3NextBtn" disabled>
                        ƒ∞leri: √ñnizleme <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Step 4: Preview + Location -->
            <div class="tab-pane fade" id="step4" role="tabpanel">
                <h5 class="mb-3">üìã √ñnizleme ve Lokasyon Se√ßimi</h5>
                <button type="button" class="btn btn-primary mb-3" onclick="loadPreview()">
                    <i class="fas fa-sync"></i> √ñnizleme Y√ºkle
                </button>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>√ñNEMLƒ∞:</strong> Lokasyon se√ßimi zorunludur. En y√ºksek stoƒüu olan lokasyon otomatik se√ßilecek.
                </div>
                
                <div id="previewContainer" class="border rounded p-3" style="max-height: 600px; overflow-y: auto;">
                    <p class="text-muted text-center">√ñnizleme y√ºklemek i√ßin butona tƒ±klayƒ±n</p>
                </div>
                
                <div class="mt-3">
                    <button type="button" class="btn btn-secondary" onclick="goToStep(3)">
                        <i class="fas fa-arrow-left"></i> Geri
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Save and Start Button -->
<div class="card mt-4">
    <div class="card-body text-center">
        <button type="button" class="btn btn-accent btn-lg" onclick="saveAndStartSync()" id="saveStartBtn" disabled>
            <i class="fas fa-rocket"></i> Kaydet ve Aktarƒ±mƒ± Ba≈ülat
        </button>
        <p class="text-muted mt-2 mb-0">Se√ßilen filtreleri kaydet ve aktarƒ±m sayfasƒ±na git</p>
    </div>
</div>

<!-- Selected Summary -->
<div class="card mt-4" id="filtersSummary" style="display: none;">
    <div class="card-header bg-info text-white">
        <h6 class="mb-0"><i class="fas fa-list-check"></i> Se√ßilen Filtreler</h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3"><strong>Kategoriler:</strong> <span id="summaryCategories">0</span></div>
            <div class="col-md-3"><strong>Stiller:</strong> <span id="summaryStyles">0</span></div>
            <div class="col-md-3"><strong>Markalar:</strong> <span id="summaryBrands">0</span></div>
            <div class="col-md-3"><strong>Lokasyon:</strong> <span id="summaryLocation">-</span></div>
        </div>
    </div>
</div>

<!-- Stock Detail Modal -->
<div class="modal fade" id="stockDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="stockDetailModalTitle">
                    <i class="fas fa-boxes"></i> Stok Detaylarƒ±
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="stockDetailModalBody">
                <p class="text-center text-muted">Y√ºkleniyor...</p>
            </div>
            <div class="modal-footer">
                <div class="me-auto" id="stockDetailSummary"></div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

<!-- Arbitraj Modal -->
<div class="modal fade" id="arbitrajModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="fas fa-tags"></i> Fiyat Arbitrajƒ± Ayarlarƒ±
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle"></i>
                    <strong>Lokasyon:</strong> <span id="arbitrajLocationName"></span>
                </div>
                
                <!-- Enable/Disable -->
                <div class="form-check form-switch mb-4">
                    <input class="form-check-input" type="checkbox" id="arbitrajEnabled">
                    <label class="form-check-label" for="arbitrajEnabled">
                        <strong>Fiyat Arbitrajƒ±nƒ± Etkinle≈ütir</strong>
                    </label>
                </div>
                
                <div id="arbitrajOptions">
                    <!-- Pricing Mode -->
                    <div class="mb-3">
                        <label class="form-label"><strong>Fiyatlandƒ±rma Modu</strong></label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="pricingMode" id="modeMarkup" value="markup" checked>
                            <label class="form-check-label" for="modeMarkup">Kar Marjƒ± ile Hesapla</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="pricingMode" id="modeFixed" value="fixed">
                            <label class="form-check-label" for="modeFixed">Sabit Fiyat Uygula</label>
                        </div>
                    </div>
                    
                    <!-- Markup Settings -->
                    <div id="markupSettings" class="border rounded p-3 mb-3">
                        <label class="form-label">Kar Marjƒ± (%)</label>
                        <div class="input-group mb-2">
                            <span class="input-group-text">%</span>
                            <input type="number" class="form-control" id="markupPercent" value="100" min="0" max="1000">
                            <span class="input-group-text">kar</span>
                        </div>
                        <small class="text-muted">√ñrnek: %100 = 2x fiyat, %50 = 1.5x fiyat</small>
                        <div class="mt-2 p-2 bg-light rounded">
                            <strong>√ñnizleme:</strong> $10 maliyet ‚Üí <span id="markupPreview">$20.00</span> satƒ±≈ü
                        </div>
                    </div>
                    
                    <!-- Fixed Price Settings -->
                    <div id="fixedSettings" class="border rounded p-3 mb-3" style="display:none;">
                        <label class="form-label">Sabit Fiyat</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="fixedPrice" value="0" min="0" step="0.01">
                        </div>
                        <small class="text-muted">T√ºm √ºr√ºnler bu fiyattan satƒ±lacak</small>
                    </div>
                    
                    <!-- Rounding Options -->
                    <div class="mb-3">
                        <label class="form-label"><strong>Yuvarlama</strong></label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="rounding" id="roundNone" value="none" checked>
                            <label class="btn btn-outline-secondary" for="roundNone">Yok</label>
                            
                            <input type="radio" class="btn-check" name="rounding" id="round99" value="99">
                            <label class="btn btn-outline-secondary" for="round99">.99</label>
                            
                            <input type="radio" class="btn-check" name="rounding" id="round90" value="90">
                            <label class="btn btn-outline-secondary" for="round90">.90</label>
                            
                            <input type="radio" class="btn-check" name="rounding" id="round00" value="00">
                            <label class="btn btn-outline-secondary" for="round00">.00</label>
                        </div>
                        <small class="text-muted d-block mt-1">√ñrnek: $23.47 ‚Üí .99 = $23.99</small>
                    </div>
                    
                    <!-- Minimum Price -->
                    <div class="mb-3">
                        <label class="form-label"><strong>Minimum Fiyat (Opsiyonel)</strong></label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="minimumPrice" value="" min="0" step="0.01" placeholder="Bo≈ü = sƒ±nƒ±rsƒ±z">
                        </div>
                        <small class="text-muted">Hesaplanan fiyat bunun altƒ±na d√º≈ümez</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒ∞ptal</button>
                <button type="button" class="btn btn-warning" onclick="saveArbitrajSettings()">
                    <i class="fas fa-save"></i> Kaydet
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// State
let selectedCategories = [];
let selectedStyles = [];
let selectedBrands = [];
let selectedLocation = null;
let allCategories = [];
let allStyles = [];
let allBrands = [];
let previewProducts = []; // Cache for stock detail

// Arbitraj settings
let arbitrajSettings = {
    enabled: false,
    markupPercent: 100,
    roundingType: 'none',
    fixedPrice: null,
    minimumPrice: null
};

// Navigation
function goToStep(step) {
    document.getElementById(`step${step}-tab`).disabled = false;
    const tab = new bootstrap.Tab(document.getElementById(`step${step}-tab`));
    tab.show();
    
    if (step === 2 && selectedCategories.length > 0) {
        loadStyles();
    } else if (step === 3 && selectedStyles.length > 0) {
        loadBrands();
    }
}

// ==================== CATEGORIES ====================
async function loadCategories() {
    const container = document.getElementById('categoriesList');
    container.innerHTML = '<div class="text-center"><div class="spinner-border"></div> Y√ºkleniyor...</div>';
    
    try {
        const response = await fetch('/api/categories', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });
        const data = await response.json();
        
        if (data.status === 'success' && data.categories) {
            allCategories = data.categories;
            renderCategories(data.categories);
        } else {
            container.innerHTML = `<div class="alert alert-danger">${data.message || 'Y√ºkleme hatasƒ±'}</div>`;
        }
    } catch (error) {
        container.innerHTML = `<div class="alert alert-danger">Hata: ${error.message}</div>`;
    }
}

function renderCategories(categories) {
    const container = document.getElementById('categoriesList');
    container.innerHTML = categories.map(cat => `
        <div class="filter-checkbox ${selectedCategories.includes(cat.categoryID) ? 'selected' : ''}" 
             data-id="${cat.categoryID}" data-name="${cat.name || cat.categoryName || ''}" onclick="toggleItem('categories', ${cat.categoryID}, this)">
            <input type="checkbox" ${selectedCategories.includes(cat.categoryID) ? 'checked' : ''} style="pointer-events: none;">
            ${cat.name || cat.categoryName || 'Kategori ' + cat.categoryID}
        </div>
    `).join('');
    updateButtons();
}

// ==================== STYLES ====================
async function loadStyles() {
    const container = document.getElementById('stylesList');
    container.innerHTML = '<div class="text-center"><div class="spinner-border"></div> Y√ºkleniyor...</div>';
    
    try {
        const response = await fetch('/api/styles', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ category_ids: selectedCategories })
        });
        const data = await response.json();
        
        const styles = data.styles || [];
        if (styles.length > 0) {
            allStyles = styles;
            renderStyles(styles);
        } else if (data.status === 'error') {
            container.innerHTML = `<div class="alert alert-danger">${data.message || 'Y√ºkleme hatasƒ±'}</div>`;
        } else {
            container.innerHTML = '<div class="alert alert-warning">Se√ßilen kategorilerde stil bulunamadƒ±</div>';
        }
    } catch (error) {
        container.innerHTML = `<div class="alert alert-danger">Hata: ${error.message}</div>`;
    }
}

function renderStyles(styles) {
    const container = document.getElementById('stylesList');
    container.innerHTML = styles.slice(0, 200).map(style => `
        <div class="filter-checkbox ${selectedStyles.includes(style.styleID) ? 'selected' : ''}" 
             data-id="${style.styleID}" data-name="${style.styleName || style.title || ''}" onclick="toggleItem('styles', ${style.styleID}, this)">
            <input type="checkbox" ${selectedStyles.includes(style.styleID) ? 'checked' : ''} style="pointer-events: none;">
            <strong>${style.styleName || style.title || 'Style ' + style.styleID}</strong>
            <small class="text-muted ms-2">${style.brandName || ''}</small>
        </div>
    `).join('');
    
    if (styles.length > 200) {
        container.innerHTML += `<p class="text-muted text-center mt-2">${styles.length - 200} daha var. Arama yapƒ±n.</p>`;
    }
    updateButtons();
}

// ==================== BRANDS ====================
async function loadBrands() {
    const container = document.getElementById('brandsList');
    container.innerHTML = '<div class="text-center"><div class="spinner-border"></div> Y√ºkleniyor...</div>';
    
    try {
        const response = await fetch('/api/brands', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ style_ids: selectedStyles })
        });
        const data = await response.json();
        
        const brands = data.brands || data.all_brands || [];
        if (brands.length > 0) {
            allBrands = brands;
            renderBrands(brands);
        } else if (data.status === 'error') {
            container.innerHTML = `<div class="alert alert-danger">${data.message || 'Y√ºkleme hatasƒ±'}</div>`;
        } else {
            container.innerHTML = '<div class="alert alert-warning">Marka bulunamadƒ±</div>';
        }
    } catch (error) {
        container.innerHTML = `<div class="alert alert-danger">Hata: ${error.message}</div>`;
    }
}

function renderBrands(brands) {
    const container = document.getElementById('brandsList');
    container.innerHTML = brands.map(brand => `
        <div class="filter-checkbox ${selectedBrands.includes(brand.brandID) ? 'selected' : ''}" 
             data-id="${brand.brandID}" data-name="${brand.name || brand.brandName || ''}" onclick="toggleItem('brands', ${brand.brandID}, this)">
            <input type="checkbox" ${selectedBrands.includes(brand.brandID) ? 'checked' : ''} style="pointer-events: none;">
            ${brand.name || brand.brandName}
            ${brand.activeProducts ? `<small class="text-muted ms-2">(${brand.activeProducts} √ºr√ºn)</small>` : ''}
        </div>
    `).join('');
    updateButtons();
}

// ==================== PREVIEW + LOCATIONS ====================
async function loadPreview() {
    const container = document.getElementById('previewContainer');
    container.innerHTML = '<div class="text-center"><div class="spinner-border"></div> Y√ºkleniyor...</div>';
    
    try {
        // Parallel API calls
        const [countResponse, whResponse] = await Promise.all([
            fetch('/api/products/count', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sync_options: {
                        filter_categories: selectedCategories,
                        filter_styles: selectedStyles,
                        filter_brands: selectedBrands
                    }
                })
            }),
            fetch('/api/warehouses', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            })
        ]);
        
        const countData = await countResponse.json();
        const whData = await whResponse.json();
        
        console.log('Count Response:', countData);
        console.log('Warehouses Response:', whData);
        
        // Check for API errors
        if (countData.status === 'error') {
            container.innerHTML = `<div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> <strong>√úr√ºn sayƒ±sƒ± alƒ±namadƒ±:</strong> ${countData.message}
                <br><small>API Ayarlarƒ± sayfasƒ±ndan credentials'larƒ± kontrol edin.</small>
            </div>`;
            return;
        }
        
        if (whData.status === 'error') {
            container.innerHTML = `<div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> <strong>Lokasyonlar alƒ±namadƒ±:</strong> ${whData.message}
                <br><small>API Ayarlarƒ± sayfasƒ±ndan credentials'larƒ± kontrol edin.</small>
            </div>`;
            return;
        }
        
        const productCount = countData.count || 0;
        
        // Check if no filters selected
        if (selectedCategories.length === 0 && selectedStyles.length === 0 && selectedBrands.length === 0) {
            container.innerHTML = `<div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i> 
                <strong>Filtre se√ßilmedi!</strong> L√ºtfen en az bir kategori, stil veya marka se√ßin.
            </div>`;
            return;
        }
        
        let html = `
            <div class="alert alert-${productCount > 0 ? 'success' : 'warning'} mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div><strong>${productCount > 0 ? '‚úÖ' : '‚ö†Ô∏è'} ${productCount.toLocaleString()} √ºr√ºn bulundu</strong></div>
                    ${productCount > 0 ? `<button type="button" class="btn btn-sm btn-dark" onclick="showAllProductsDetail()">
                        <i class="fas fa-list"></i> T√ºm √úr√ºnleri G√∂r
                    </button>` : ''}
                </div>
            </div>
        `;
        
        if (whData.status === 'success' && whData.warehouses && whData.warehouses.length > 0) {
            const warehouses = whData.warehouses.sort((a, b) => (b.total_stock || 0) - (a.total_stock || 0));
            
            html += '<h6 class="mb-3">üìç Lokasyon Se√ßin (Zorunlu):</h6>';
            html += '<div class="list-group mb-3">';
            
            warehouses.forEach((wh, idx) => {
                const code = wh.code || wh.id || 'UNKNOWN';
                const name = wh.name || code;
                const stock = wh.total_stock || 0;
                const skuCount = wh.product_count || 0;
                const isHighest = idx === 0;
                const isSelected = idx === 0;
                
                html += `
                    <div class="list-group-item ${isSelected ? 'list-group-item-success' : ''}" id="loc-item-${code}">
                        <div class="d-flex align-items-center">
                            <div class="form-check flex-grow-1">
                                <input class="form-check-input" type="radio" name="selectedLocation" 
                                       id="loc-${code}" value="${code}" ${isSelected ? 'checked' : ''}
                                       onchange="selectLocation('${code}')">
                                <label class="form-check-label" for="loc-${code}">
                                    <strong>${name}</strong>
                                    <small class="text-muted">(${code})</small>
                                </label>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                ${isHighest ? '<span class="badge bg-success">EN Y√úKSEK STOK</span>' : ''}
                                <span class="badge bg-primary">${stock.toLocaleString()} adet</span>
                                <span class="badge bg-secondary">${skuCount.toLocaleString()} SKU</span>
                                <button type="button" class="btn btn-sm btn-outline-info" 
                                        onclick="showStockDetail('${code}', '${name}')" title="Stok Detaylarƒ±">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-warning arbitraj-btn" 
                                        id="arbitraj-btn-${code}"
                                        onclick="showArbitrajModal('${code}', '${name}')"
                                        title="Fiyat Ayarƒ±" style="${isSelected ? '' : 'display:none;'}">
                                    <i class="fas fa-tags"></i> Fiyat Ayarƒ±
                                </button>
                            </div>
                        </div>
                        <div class="arbitraj-indicator mt-2" id="arbitraj-indicator-${code}" style="display:none;">
                            <small class="text-warning">
                                <i class="fas fa-calculator"></i> <span id="arbitraj-summary-${code}"></span>
                            </small>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Auto-select highest stock
            if (warehouses.length > 0) {
                selectedLocation = warehouses[0].code || warehouses[0].id;
            }
        } else {
            html += '<div class="alert alert-warning">Lokasyon bilgisi alƒ±namadƒ±</div>';
        }
        
        container.innerHTML = html;
        document.getElementById('filtersSummary').style.display = 'block';
        updateSummary();
        updateButtons();
        
    } catch (error) {
        container.innerHTML = `<div class="alert alert-danger">Hata: ${error.message}</div>`;
        console.error('Preview error:', error);
    }
}

// ==================== STOCK DETAIL MODAL ====================
async function showStockDetail(locationCode, locationName) {
    const modal = new bootstrap.Modal(document.getElementById('stockDetailModal'));
    const modalBody = document.getElementById('stockDetailModalBody');
    const modalTitle = document.getElementById('stockDetailModalTitle');
    const modalSummary = document.getElementById('stockDetailSummary');
    
    modalTitle.innerHTML = `<i class="fas fa-boxes"></i> ${locationName} (${locationCode}) - Stok Detaylarƒ±`;
    modalBody.innerHTML = '<div class="text-center py-4"><div class="spinner-border"></div><p class="mt-2">Y√ºkleniyor...</p></div>';
    modalSummary.innerHTML = '';
    
    modal.show();
    
    try {
        const response = await fetch('/api/preview', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                sync_options: {
                    filter_categories: selectedCategories,
                    filter_styles: selectedStyles,
                    filter_brands: selectedBrands,
                    filter_warehouses: [locationCode]
                }
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'error') {
            modalBody.innerHTML = `<div class="alert alert-danger">${data.message || 'Hata'}</div>`;
            return;
        }
        
        const products = data.products || [];
        previewProducts = products; // Cache
        renderStockDetailTable(products, modalBody, modalSummary);
        
    } catch (error) {
        modalBody.innerHTML = `<div class="alert alert-danger">Hata: ${error.message}</div>`;
    }
}

function showAllProductsDetail() {
    const modal = new bootstrap.Modal(document.getElementById('stockDetailModal'));
    const modalBody = document.getElementById('stockDetailModalBody');
    const modalTitle = document.getElementById('stockDetailModalTitle');
    const modalSummary = document.getElementById('stockDetailSummary');
    
    modalTitle.innerHTML = '<i class="fas fa-boxes"></i> T√ºm Filtrelenmi≈ü √úr√ºnler';
    
    if (!previewProducts || previewProducts.length === 0) {
        modalBody.innerHTML = '<div class="alert alert-warning">√ñnce bir lokasyonun stok detaylarƒ±nƒ± g√∂r√ºnt√ºleyin.</div>';
        modal.show();
        return;
    }
    
    renderStockDetailTable(previewProducts, modalBody, modalSummary);
    modal.show();
}

function renderStockDetailTable(products, container, summaryContainer) {
    if (!products || products.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">√úr√ºn bulunamadƒ±.</div>';
        summaryContainer.innerHTML = '';
        return;
    }
    
    // Group by style
    const styleGroups = {};
    let totalStock = 0;
    let totalSKUs = 0;
    
    products.forEach(p => {
        const styleId = p.styleID || 'unknown';
        const styleName = `${p.brandName || ''} ${p.styleName || ''}`.trim() || 'Bilinmeyen';
        
        if (!styleGroups[styleId]) {
            styleGroups[styleId] = { styleId, styleName, products: [] };
        }
        styleGroups[styleId].products.push(p);
        totalStock += (p.qty || 0);
        totalSKUs++;
    });
    
    let html = `
        <div class="mb-3">
            <input type="text" class="form-control" id="stockSearchInput" 
                   placeholder="üîç SKU, Renk veya Beden ara..." onkeyup="filterStockTable()">
        </div>
        <div class="stock-table-container">
            <table class="table table-sm table-hover table-striped" id="stockDetailTable">
                <thead class="table-dark">
                    <tr>
                        <th>SKU</th>
                        <th>√úr√ºn</th>
                        <th>Renk</th>
                        <th>Beden</th>
                        <th class="text-end">Stok</th>
                        <th class="text-end">Fiyat</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    const sortedStyles = Object.values(styleGroups).sort((a, b) => a.styleName.localeCompare(b.styleName));
    
    sortedStyles.forEach(style => {
        const styleStock = style.products.reduce((sum, p) => sum + (p.qty || 0), 0);
        html += `
            <tr class="style-header">
                <td colspan="4"><strong>${style.styleName}</strong> <small>(ID: ${style.styleId})</small></td>
                <td class="text-end"><strong>${styleStock.toLocaleString()}</strong></td>
                <td></td>
            </tr>
        `;
        
        const sortedProducts = style.products.sort((a, b) => {
            const colorCmp = (a.colorName || '').localeCompare(b.colorName || '');
            return colorCmp !== 0 ? colorCmp : (a.sizeName || '').localeCompare(b.sizeName || '');
        });
        
        sortedProducts.forEach(p => {
            const qty = p.qty || 0;
            const price = p.customerPrice || p.piecePrice || 0;
            const stockClass = qty > 100 ? 'stock-high' : qty > 0 ? 'stock-medium' : 'stock-low';
            
            html += `
                <tr data-sku="${p.sku || ''}" data-color="${(p.colorName || '').toLowerCase()}" data-size="${(p.sizeName || '').toLowerCase()}">
                    <td><code>${p.sku || '-'}</code></td>
                    <td class="text-truncate" style="max-width: 150px;">${style.styleName}</td>
                    <td>${p.colorName || '-'}</td>
                    <td>${p.sizeName || '-'}</td>
                    <td class="text-end ${stockClass}">${qty.toLocaleString()}</td>
                    <td class="text-end">$${parseFloat(price).toFixed(2)}</td>
                </tr>
            `;
        });
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
    
    summaryContainer.innerHTML = `
        <span class="badge bg-primary me-2">${totalSKUs.toLocaleString()} SKU</span>
        <span class="badge bg-success me-2">${totalStock.toLocaleString()} Toplam Stok</span>
        <span class="badge bg-info">${Object.keys(styleGroups).length} Stil</span>
    `;
}

function filterStockTable() {
    const filter = (document.getElementById('stockSearchInput')?.value || '').toLowerCase();
    const rows = document.querySelectorAll('#stockDetailTable tbody tr');
    
    rows.forEach(row => {
        if (row.classList.contains('style-header')) {
            row.style.display = '';
            return;
        }
        
        const sku = row.getAttribute('data-sku') || '';
        const color = row.getAttribute('data-color') || '';
        const size = row.getAttribute('data-size') || '';
        const text = row.textContent.toLowerCase();
        
        row.style.display = (filter === '' || sku.includes(filter) || color.includes(filter) || size.includes(filter) || text.includes(filter)) ? '' : 'none';
    });
}

// ==================== ARBITRAJ MODAL ====================
function showArbitrajModal(locationCode, locationName) {
    document.getElementById('arbitrajLocationName').textContent = `${locationName} (${locationCode})`;
    
    // Load current settings
    document.getElementById('arbitrajEnabled').checked = arbitrajSettings.enabled;
    document.getElementById('markupPercent').value = arbitrajSettings.markupPercent;
    document.getElementById('fixedPrice').value = arbitrajSettings.fixedPrice || '';
    document.getElementById('minimumPrice').value = arbitrajSettings.minimumPrice || '';
    
    // Set pricing mode
    if (arbitrajSettings.fixedPrice !== null) {
        document.getElementById('modeFixed').checked = true;
        document.getElementById('markupSettings').style.display = 'none';
        document.getElementById('fixedSettings').style.display = 'block';
    } else {
        document.getElementById('modeMarkup').checked = true;
        document.getElementById('markupSettings').style.display = 'block';
        document.getElementById('fixedSettings').style.display = 'none';
    }
    
    // Set rounding
    const roundingRadio = document.querySelector(`input[name="rounding"][value="${arbitrajSettings.roundingType}"]`);
    if (roundingRadio) roundingRadio.checked = true;
    
    updateMarkupPreview();
    
    const modal = new bootstrap.Modal(document.getElementById('arbitrajModal'));
    modal.show();
}

function saveArbitrajSettings() {
    arbitrajSettings.enabled = document.getElementById('arbitrajEnabled').checked;
    arbitrajSettings.markupPercent = parseFloat(document.getElementById('markupPercent').value) || 0;
    arbitrajSettings.roundingType = document.querySelector('input[name="rounding"]:checked')?.value || 'none';
    
    const pricingMode = document.querySelector('input[name="pricingMode"]:checked')?.value;
    if (pricingMode === 'fixed') {
        arbitrajSettings.fixedPrice = parseFloat(document.getElementById('fixedPrice').value) || null;
    } else {
        arbitrajSettings.fixedPrice = null;
    }
    
    const minPrice = document.getElementById('minimumPrice').value;
    arbitrajSettings.minimumPrice = minPrice ? parseFloat(minPrice) : null;
    
    console.log('Arbitraj saved:', arbitrajSettings);
    
    updateArbitrajIndicator();
    bootstrap.Modal.getInstance(document.getElementById('arbitrajModal')).hide();
    
    // Toast notification
    showToast('Fiyat arbitrajƒ± ayarlarƒ± kaydedildi!');
}

function updateArbitrajIndicator() {
    if (!selectedLocation) return;
    
    const indicator = document.getElementById(`arbitraj-indicator-${selectedLocation}`);
    const summary = document.getElementById(`arbitraj-summary-${selectedLocation}`);
    const btn = document.getElementById(`arbitraj-btn-${selectedLocation}`);
    
    if (arbitrajSettings.enabled) {
        let summaryText = '';
        if (arbitrajSettings.fixedPrice !== null) {
            summaryText = `Sabit: $${arbitrajSettings.fixedPrice.toFixed(2)}`;
        } else {
            summaryText = `+%${arbitrajSettings.markupPercent} kar`;
        }
        
        if (arbitrajSettings.roundingType !== 'none') {
            summaryText += ` | .${arbitrajSettings.roundingType}`;
        }
        if (arbitrajSettings.minimumPrice) {
            summaryText += ` | Min: $${arbitrajSettings.minimumPrice.toFixed(2)}`;
        }
        
        if (indicator) {
            indicator.style.display = 'block';
            summary.textContent = summaryText;
        }
        if (btn) {
            btn.classList.add('arbitraj-btn-active');
            btn.innerHTML = '<i class="fas fa-check"></i> Fiyat Ayarlƒ±';
        }
    } else {
        if (indicator) indicator.style.display = 'none';
        if (btn) {
            btn.classList.remove('arbitraj-btn-active');
            btn.innerHTML = '<i class="fas fa-tags"></i> Fiyat Ayarƒ±';
        }
    }
}

function updateMarkupPreview() {
    const markup = parseFloat(document.getElementById('markupPercent').value) || 0;
    const rounding = document.querySelector('input[name="rounding"]:checked')?.value || 'none';
    
    let price = 10 * (1 + markup / 100);
    price = applyRounding(price, rounding);
    
    document.getElementById('markupPreview').textContent = `$${price.toFixed(2)}`;
}

function applyRounding(price, type) {
    switch (type) {
        case '99': return Math.floor(price) + 0.99;
        case '90': return Math.floor(price) + 0.90;
        case '00': return Math.ceil(price);
        default: return price;
    }
}

// Setup arbitraj modal listeners
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('input[name="pricingMode"]').forEach(radio => {
        radio.addEventListener('change', function() {
            document.getElementById('markupSettings').style.display = this.value === 'markup' ? 'block' : 'none';
            document.getElementById('fixedSettings').style.display = this.value === 'fixed' ? 'block' : 'none';
        });
    });
    
    document.getElementById('markupPercent')?.addEventListener('input', updateMarkupPreview);
    document.querySelectorAll('input[name="rounding"]').forEach(r => r.addEventListener('change', updateMarkupPreview));
});

// ==================== LOCATION SELECTION ====================
function selectLocation(code) {
    selectedLocation = code;
    console.log('Selected location:', code);
    
    // Update styling
    document.querySelectorAll('.list-group-item').forEach(item => {
        item.classList.remove('list-group-item-success');
    });
    const selectedItem = document.getElementById(`loc-item-${code}`);
    if (selectedItem) selectedItem.classList.add('list-group-item-success');
    
    // Show/hide arbitraj buttons
    document.querySelectorAll('.arbitraj-btn').forEach(btn => btn.style.display = 'none');
    const arbitrajBtn = document.getElementById(`arbitraj-btn-${code}`);
    if (arbitrajBtn) arbitrajBtn.style.display = '';
    
    updateButtons();
    updateSummary();
}

// ==================== COMMON FUNCTIONS ====================
function toggleItem(type, id, element) {
    let array;
    if (type === 'categories') array = selectedCategories;
    else if (type === 'styles') array = selectedStyles;
    else if (type === 'brands') array = selectedBrands;
    
    const index = array.indexOf(id);
    if (index > -1) {
        array.splice(index, 1);
        element.classList.remove('selected');
        element.querySelector('input').checked = false;
    } else {
        array.push(id);
        element.classList.add('selected');
        element.querySelector('input').checked = true;
    }
    updateButtons();
    updateSummary();
}

function toggleAll(type) {
    const checkAll = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`).checked;
    const container = document.getElementById(`${type}List`);
    const items = container.querySelectorAll('.filter-checkbox');
    
    if (type === 'categories') selectedCategories = [];
    else if (type === 'styles') selectedStyles = [];
    else if (type === 'brands') selectedBrands = [];
    
    items.forEach(item => {
        const id = parseInt(item.dataset.id);
        if (checkAll) {
            if (type === 'categories') selectedCategories.push(id);
            else if (type === 'styles') selectedStyles.push(id);
            else if (type === 'brands') selectedBrands.push(id);
            item.classList.add('selected');
            item.querySelector('input').checked = true;
        } else {
            item.classList.remove('selected');
            item.querySelector('input').checked = false;
        }
    });
    updateButtons();
    updateSummary();
}

function filterList(containerId, query) {
    const container = document.getElementById(containerId);
    const items = container.querySelectorAll('.filter-checkbox');
    const q = query.toLowerCase();
    
    items.forEach(item => {
        const name = item.dataset.name?.toLowerCase() || '';
        item.style.display = name.includes(q) ? 'block' : 'none';
    });
}

function updateButtons() {
    document.getElementById('step1NextBtn').disabled = selectedCategories.length === 0;
    document.getElementById('step2NextBtn').disabled = selectedStyles.length === 0;
    document.getElementById('step3NextBtn').disabled = selectedBrands.length === 0;
    document.getElementById('saveStartBtn').disabled = !selectedLocation;
}

function updateSummary() {
    document.getElementById('summaryCategories').textContent = selectedCategories.length;
    document.getElementById('summaryStyles').textContent = selectedStyles.length;
    document.getElementById('summaryBrands').textContent = selectedBrands.length;
    document.getElementById('summaryLocation').textContent = selectedLocation || '-';
}

function resetAllFilters() {
    if (!confirm('T√ºm filtreleri sƒ±fƒ±rlamak istediƒüinizden emin misiniz?')) return;
    
    selectedCategories = [];
    selectedStyles = [];
    selectedBrands = [];
    selectedLocation = null;
    arbitrajSettings = { enabled: false, markupPercent: 100, roundingType: 'none', fixedPrice: null, minimumPrice: null };
    
    ['step2-tab', 'step3-tab', 'step4-tab'].forEach(id => document.getElementById(id).disabled = true);
    
    goToStep(1);
    document.getElementById('categoriesList').innerHTML = '<p class="text-muted text-center">Kategorileri y√ºklemek i√ßin butona tƒ±klayƒ±n</p>';
    document.getElementById('stylesList').innerHTML = '<p class="text-muted text-center">√ñnce kategorileri se√ßin</p>';
    document.getElementById('brandsList').innerHTML = '<p class="text-muted text-center">√ñnce stilleri se√ßin</p>';
    document.getElementById('previewContainer').innerHTML = '<p class="text-muted text-center">√ñnizleme y√ºklemek i√ßin butona tƒ±klayƒ±n</p>';
    document.getElementById('filtersSummary').style.display = 'none';
    updateButtons();
}

// ==================== SAVE AND START ====================
async function saveAndStartSync() {
    if (!selectedLocation) {
        alert('L√ºtfen bir lokasyon se√ßin!');
        return;
    }
    
    const syncOptions = {
        filter_categories: selectedCategories,
        filter_styles: selectedStyles,
        filter_brands: selectedBrands,
        filter_warehouses: [selectedLocation],
        arbitraj_settings: arbitrajSettings.enabled ? arbitrajSettings : null
    };
    
    try {
        await fetch('/api/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sync_options: syncOptions })
        });
        
        window.location.href = '/sync?autostart=1';
    } catch (error) {
        alert('Kaydetme hatasƒ±: ' + error.message);
    }
}

// Toast notification
function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'alert alert-success position-fixed';
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 250px;';
    toast.innerHTML = `${message} <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// Load saved filters on page load
document.addEventListener('DOMContentLoaded', async function() {
    try {
        const response = await fetch('/api/config');
        const data = await response.json();
        
        if (data.sync_options) {
            selectedCategories = data.sync_options.filter_categories || [];
            selectedStyles = data.sync_options.filter_styles || [];
            selectedBrands = data.sync_options.filter_brands || [];
            selectedLocation = data.sync_options.filter_warehouses?.[0] || null;
            
            if (data.sync_options.arbitraj_settings) {
                arbitrajSettings = data.sync_options.arbitraj_settings;
            }
            
            if (selectedCategories.length > 0 || selectedStyles.length > 0 || selectedBrands.length > 0) {
                document.getElementById('filtersSummary').style.display = 'block';
                updateSummary();
                updateButtons();
            }
        }
    } catch (error) {
        console.error('Error loading saved filters:', error);
    }
});
</script>
{% endblock %}
