{% extends "layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block extra_css %}
<style>
    .connection-status {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #6c757d;
    }
    .status-dot.connected { background: #28a745; }
    .status-dot.error { background: #dc3545; }
    .status-dot.checking { background: #ffc107; animation: pulse 1s infinite; }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    .sync-status-badge {
        font-size: 1rem;
        padding: 8px 16px;
    }
    .quick-stat {
        background: white;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: transform 0.2s;
    }
    .quick-stat:hover {
        transform: translateY(-3px);
    }
    .quick-stat .icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        margin-bottom: 10px;
    }
    .quick-stat h3 { margin: 0; font-size: 1.8rem; font-weight: 700; }
    .quick-stat p { margin: 5px 0 0; color: #6c757d; font-size: 0.9rem; }
</style>
{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <h2><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
    <div>
        <span class="badge bg-secondary" id="lastUpdate">Son güncelleme: -</span>
    </div>
</div>

<!-- Connection Status -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="connection-status">
                    <div class="status-dot checking" id="ssStatusDot"></div>
                    <span><strong>S&S Activewear:</strong></span>
                    <span id="ssStatus">Kontrol ediliyor...</span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="connection-status">
                    <div class="status-dot checking" id="shopifyStatusDot"></div>
                    <span><strong>Shopify:</strong></span>
                    <span id="shopifyStatus">Kontrol ediliyor...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Active Sync Status -->
<div class="alert alert-info d-flex justify-content-between align-items-center" id="activeSyncAlert" style="display: none !important;">
    <div>
        <i class="fas fa-sync fa-spin me-2"></i>
        <strong>Aktif Aktarım:</strong> <span id="activeSyncProgress">0%</span> - <span id="activeSyncMessage">İşleniyor...</span>
    </div>
    <a href="{{ url_for('page_sync') }}" class="btn btn-sm btn-primary">Detay</a>
</div>

<!-- Stats Row -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="quick-stat">
            <div class="icon bg-primary text-white"><i class="fas fa-box"></i></div>
            <h3 id="stat-total">0</h3>
            <p>Toplam İşlenen</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="quick-stat">
            <div class="icon bg-success text-white"><i class="fas fa-plus-circle"></i></div>
            <h3 id="stat-created">0</h3>
            <p>Oluşturulan</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="quick-stat">
            <div class="icon bg-warning text-dark"><i class="fas fa-sync-alt"></i></div>
            <h3 id="stat-updated">0</h3>
            <p>Güncellenen</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="quick-stat">
            <div class="icon bg-danger text-white"><i class="fas fa-exclamation-triangle"></i></div>
            <h3 id="stat-errors">0</h3>
            <p>Hatalar</p>
        </div>
    </div>
</div>

<!-- Last Sync Status -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-history"></i> Son Aktarım Durumu</h5>
        <span id="lastSyncTime" class="text-muted">-</span>
    </div>
    <div class="card-body">
        <div id="dashboard-status">
            <p class="text-muted mb-0">Henüz aktarım yapılmadı</p>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-bolt"></i> Hızlı İşlemler</h5>
    </div>
    <div class="card-body">
        <div class="d-flex gap-2 flex-wrap">
            <a href="{{ url_for('page_sync_options') }}" class="btn btn-primary btn-lg">
                <i class="fas fa-filter"></i> Filtrele ve Başlat
            </a>
            <a href="{{ url_for('page_sync') }}?autostart=1" class="btn btn-success btn-lg">
                <i class="fas fa-play"></i> Hızlı Aktarım
            </a>
            <a href="{{ url_for('page_product_search') }}" class="btn btn-outline-primary">
                <i class="fas fa-search"></i> Ürün Ara
            </a>
            <a href="{{ url_for('page_settings') }}" class="btn btn-outline-secondary">
                <i class="fas fa-cog"></i> Ayarlar
            </a>
        </div>
    </div>
</div>

<!-- Saved Filters Summary -->
<div class="card" id="savedFiltersCard" style="display: none;">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0"><i class="fas fa-filter"></i> Kayıtlı Filtreler</h5>
    </div>
    <div class="card-body" id="savedFiltersBody">
        <!-- Filters will be shown here -->
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    checkConnections();
    loadDashboardStats();
    loadSavedFilters();
    
    // Refresh every 30 seconds
    setInterval(() => {
        loadDashboardStats();
    }, 30000);
});

async function checkConnections() {
    // Check S&S
    try {
        const response = await fetch('/api/test-connection', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });
        const data = await response.json();
        
        const ssDot = document.getElementById('ssStatusDot');
        const ssStatus = document.getElementById('ssStatus');
        const shopifyDot = document.getElementById('shopifyStatusDot');
        const shopifyStatus = document.getElementById('shopifyStatus');
        
        if (data.ss) {
            ssDot.className = 'status-dot connected';
            ssStatus.textContent = 'Bağlı';
            ssStatus.className = 'text-success';
        } else {
            ssDot.className = 'status-dot error';
            ssStatus.textContent = 'Bağlantı Hatası';
            ssStatus.className = 'text-danger';
        }
        
        if (data.shopify) {
            shopifyDot.className = 'status-dot connected';
            shopifyStatus.textContent = 'Bağlı';
            shopifyStatus.className = 'text-success';
        } else {
            shopifyDot.className = 'status-dot error';
            shopifyStatus.textContent = 'Bağlantı Hatası';
            shopifyStatus.className = 'text-danger';
        }
    } catch (error) {
        console.error('Connection check error:', error);
    }
}

async function loadDashboardStats() {
    try {
        const response = await fetch('/api/sync/status');
        const data = await response.json();
        
        // Update timestamp
        document.getElementById('lastUpdate').textContent = 'Son güncelleme: ' + new Date().toLocaleTimeString();
        
        // Check for active sync
        if (data.is_running) {
            document.getElementById('activeSyncAlert').style.display = 'flex !important';
            document.getElementById('activeSyncProgress').textContent = (data.progress || 0) + '%';
            document.getElementById('activeSyncMessage').textContent = data.message || 'İşleniyor...';
        } else {
            document.getElementById('activeSyncAlert').style.display = 'none !important';
        }
        
        // Update stats
        if (data.stats) {
            document.getElementById('stat-total').textContent = data.stats.total || 0;
            document.getElementById('stat-created').textContent = data.stats.created || 0;
            document.getElementById('stat-updated').textContent = data.stats.updated || 0;
            document.getElementById('stat-errors').textContent = data.stats.errors || 0;
        }
        
        // Update last sync info
        if (data.last_sync) {
            const stats = data.last_sync;
            document.getElementById('stat-total').textContent = stats.total || 0;
            document.getElementById('stat-created').textContent = stats.created || 0;
            document.getElementById('stat-updated').textContent = stats.updated || 0;
            document.getElementById('stat-errors').textContent = stats.errors || 0;
            
            if (stats.timestamp) {
                document.getElementById('lastSyncTime').textContent = new Date(stats.timestamp).toLocaleString();
            }
            
            const alertClass = stats.errors > 0 ? 'warning' : 'success';
            document.getElementById('dashboard-status').innerHTML = `
                <div class="alert alert-${alertClass} mb-0">
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>${stats.errors > 0 ? '⚠️' : '✅'} Son Aktarım Özeti</strong>
                        </div>
                    </div>
                    <hr class="my-2">
                    <div class="row">
                        <div class="col-md-3"><strong>${stats.total || 0}</strong> toplam işlendi</div>
                        <div class="col-md-3"><strong>${stats.created || 0}</strong> oluşturuldu</div>
                        <div class="col-md-3"><strong>${stats.updated || 0}</strong> güncellendi</div>
                        <div class="col-md-3"><strong>${stats.errors || 0}</strong> hata</div>
                    </div>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading dashboard stats:', error);
    }
}

async function loadSavedFilters() {
    try {
        const response = await fetch('/api/config');
        const data = await response.json();
        
        if (data.sync_options) {
            const opts = data.sync_options;
            const categories = opts.filter_categories || [];
            const styles = opts.filter_styles || [];
            const brands = opts.filter_brands || [];
            const warehouses = opts.filter_warehouses || [];
            
            if (categories.length > 0 || styles.length > 0 || brands.length > 0 || warehouses.length > 0) {
                document.getElementById('savedFiltersCard').style.display = 'block';
                document.getElementById('savedFiltersBody').innerHTML = `
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Kategoriler:</strong> ${categories.length} seçili
                        </div>
                        <div class="col-md-3">
                            <strong>Stiller:</strong> ${styles.length} seçili
                        </div>
                        <div class="col-md-3">
                            <strong>Markalar:</strong> ${brands.length} seçili
                        </div>
                        <div class="col-md-3">
                            <strong>Lokasyon:</strong> ${warehouses.length > 0 ? warehouses[0] : '-'}
                        </div>
                    </div>
                    <div class="mt-3">
                        <a href="{{ url_for('page_sync_options') }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-edit"></i> Filtreleri Düzenle
                        </a>
                    </div>
                `;
            }
        }
    } catch (error) {
        console.error('Error loading saved filters:', error);
    }
}
</script>
{% endblock %}
