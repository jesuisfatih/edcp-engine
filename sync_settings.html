{% extends "layout.html" %}

{% block title %}Aktarım Ayarları{% endblock %}

{% block content %}
<div class="page-header">
    <h2><i class="fas fa-tasks"></i> Aktarım Ayarları</h2>
</div>

<div id="loadingOverlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:9999; display:flex; align-items:center; justify-content:center;">
    <div class="text-center text-white">
        <div class="spinner-border mb-3" style="width:3rem; height:3rem;"></div>
        <h4>Ayarlar yükleniyor...</h4>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <!-- Sync Mode -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-sync"></i> Senkronizasyon Modu</h5>
            </div>
            <div class="card-body">
                <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="syncMode" id="syncModeCreate" value="create">
                    <label class="form-check-label" for="syncModeCreate">
                        <strong>Sadece Oluştur</strong>
                        <br><small class="text-muted">Yeni ürünleri oluşturur, mevcut ürünleri güncellemez</small>
                    </label>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="syncMode" id="syncModeUpdate" value="update">
                    <label class="form-check-label" for="syncModeUpdate">
                        <strong>Oluştur ve Güncelle</strong>
                        <br><small class="text-muted">Yeni ürünleri oluşturur, mevcutları günceller</small>
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="syncMode" id="syncModeSync" value="sync">
                    <label class="form-check-label" for="syncModeSync">
                        <strong>Tam Senkronizasyon</strong>
                        <br><small class="text-muted">API'de olmayan Shopify ürünlerini de siler</small>
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Force Sync Option -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-bolt"></i> Zorunlu Yeniden Aktarım</h5>
            </div>
            <div class="card-body">
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="forceSync">
                    <label class="form-check-label" for="forceSync">
                        <strong>Tüm Ürünleri Zorla Aktar</strong>
                        <br><small class="text-muted">Değişiklik kontrolü yapılmadan tüm ürünleri yeniden aktarır</small>
                    </label>
                </div>
                <button type="button" class="btn btn-warning btn-sm" onclick="clearSnapshots()">
                    <i class="fas fa-trash"></i> Aktarım Geçmişini Temizle
                </button>
                <small class="text-muted d-block mt-2">Bu, tüm ürünlerin "yeni" olarak algılanmasını sağlar</small>
            </div>
        </div>

        <!-- Inventory Settings -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-boxes"></i> Stok Ayarları</h5>
            </div>
            <div class="card-body">
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="syncInventory">
                    <label class="form-check-label" for="syncInventory">Stokları Senkronize Et</label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="trackInventory">
                    <label class="form-check-label" for="trackInventory">Shopify Stok Takibi</label>
                </div>
                <div class="mb-3">
                    <label class="form-label">Minimum Stok Uyarısı</label>
                    <input type="number" class="form-control" id="lowStockThreshold" value="10" min="0">
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <!-- Product Settings -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-box"></i> Ürün Ayarları</h5>
            </div>
            <div class="card-body">
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="publishProducts">
                    <label class="form-check-label" for="publishProducts">Ürünleri Yayınla (Active)</label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="syncImages">
                    <label class="form-check-label" for="syncImages">Görselleri Aktır</label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="syncMetafields">
                    <label class="form-check-label" for="syncMetafields">Metafield'ları Aktar</label>
                </div>
                <div class="mb-3">
                    <label class="form-label">Ürün Başlığı Formatı</label>
                    <select class="form-select" id="titleFormat">
                        <option value="brand_style">{Brand} {StyleName}</option>
                        <option value="style_only">{StyleName}</option>
                        <option value="brand_style_id">{Brand} {StyleName} ({StyleID})</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Collection Settings -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-folder"></i> Koleksiyon Ayarları</h5>
            </div>
            <div class="card-body">
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="createBrandCollections">
                    <label class="form-check-label" for="createBrandCollections">Marka Koleksiyonları Oluştur</label>
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="createCategoryCollections">
                    <label class="form-check-label" for="createCategoryCollections">Kategori Koleksiyonları Oluştur</label>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card mt-3">
    <div class="card-body text-center">
        <button class="btn btn-accent btn-lg" id="saveBtn" onclick="saveSyncSettings()">
            <i class="fas fa-save"></i> Ayarları Kaydet
        </button>
        <div id="saveStatus" class="mt-2" style="display:none;"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Default values
const defaultSettings = {
    sync_mode: 'create',
    force_sync: false,
    sync_inventory: true,
    track_inventory: true,
    low_stock_threshold: 10,
    publish_products: true,
    sync_images: true,
    sync_metafields: true,
    title_format: 'brand_style',
    create_brand_collections: true,
    create_category_collections: true
};

document.addEventListener('DOMContentLoaded', loadSyncSettings);

async function loadSyncSettings() {
    const overlay = document.getElementById('loadingOverlay');
    overlay.style.display = 'flex';
    
    try {
        const response = await fetch('/api/config');
        const data = await response.json();
        
        const opts = data.sync_options || {};
        
        // Apply settings with defaults
        const settings = { ...defaultSettings, ...opts };
        
        // Sync Mode
        const syncModeRadio = document.querySelector(`input[name="syncMode"][value="${settings.sync_mode}"]`);
        if (syncModeRadio) syncModeRadio.checked = true;
        else document.getElementById('syncModeCreate').checked = true;
        
        // Force Sync
        document.getElementById('forceSync').checked = settings.force_sync === true;
        
        // Checkboxes
        document.getElementById('syncInventory').checked = settings.sync_inventory !== false;
        document.getElementById('trackInventory').checked = settings.track_inventory !== false;
        document.getElementById('publishProducts').checked = settings.publish_products !== false;
        document.getElementById('syncImages').checked = settings.sync_images !== false;
        document.getElementById('syncMetafields').checked = settings.sync_metafields !== false;
        document.getElementById('createBrandCollections').checked = settings.create_brand_collections !== false;
        document.getElementById('createCategoryCollections').checked = settings.create_category_collections !== false;
        
        // Number inputs
        document.getElementById('lowStockThreshold').value = settings.low_stock_threshold || 10;
        
        // Select
        document.getElementById('titleFormat').value = settings.title_format || 'brand_style';
        
        console.log('Settings loaded:', settings);
        
    } catch (error) {
        console.error('Error loading settings:', error);
        showStatus('Ayarlar yüklenirken hata oluştu: ' + error.message, 'danger');
    } finally {
        overlay.style.display = 'none';
    }
}

async function saveSyncSettings() {
    const saveBtn = document.getElementById('saveBtn');
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Kaydediliyor...';
    
    const settings = {
        sync_mode: document.querySelector('input[name="syncMode"]:checked')?.value || 'create',
        force_sync: document.getElementById('forceSync').checked,
        sync_inventory: document.getElementById('syncInventory').checked,
        track_inventory: document.getElementById('trackInventory').checked,
        low_stock_threshold: parseInt(document.getElementById('lowStockThreshold').value) || 10,
        publish_products: document.getElementById('publishProducts').checked,
        sync_images: document.getElementById('syncImages').checked,
        sync_metafields: document.getElementById('syncMetafields').checked,
        title_format: document.getElementById('titleFormat').value,
        create_brand_collections: document.getElementById('createBrandCollections').checked,
        create_category_collections: document.getElementById('createCategoryCollections').checked
    };
    
    try {
        const response = await fetch('/api/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sync_options: settings })
        });
        const data = await response.json();
        
        if (data.status === 'success' || response.ok) {
            showStatus('✅ Ayarlar başarıyla kaydedildi!', 'success');
        } else {
            showStatus('❌ Hata: ' + (data.message || 'Bilinmeyen hata'), 'danger');
        }
    } catch (error) {
        showStatus('❌ Kaydetme hatası: ' + error.message, 'danger');
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Ayarları Kaydet';
    }
}

function showStatus(message, type) {
    const statusDiv = document.getElementById('saveStatus');
    statusDiv.innerHTML = `<div class="alert alert-${type} py-2">${message}</div>`;
    statusDiv.style.display = 'block';
    setTimeout(() => { statusDiv.style.display = 'none'; }, 3000);
}

async function clearSnapshots() {
    if (!confirm('Tüm aktarım geçmişi silinecek. Bu işlem sonraki aktarımda TÜM ürünlerin yeniden aktarılmasına neden olur. Devam edilsin mi?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/sync/clear-snapshots', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });
        const data = await response.json();
        
        if (data.status === 'success') {
            showStatus('✅ Aktarım geçmişi temizlendi: ' + (data.cleared || 0) + ' kayıt silindi', 'success');
        } else {
            showStatus('❌ Hata: ' + data.message, 'danger');
        }
    } catch (error) {
        showStatus('❌ Hata: ' + error.message, 'danger');
    }
}
</script>
{% endblock %}
